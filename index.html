<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#5D4037">
    <meta name="description" content="–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏ –∫–∞—Ä–º–∏—á–µ—Å–∫–∏—Ö —Å–µ–º—è–Ω –ø–æ –∫–Ω–∏–≥–∞–º –ú–∞–π–∫–ª–∞ –†–æ—É—á–∞">
    
    <!-- PWA –¥–ª—è iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="–°–∞–¥ –ö–∞—Ä–º—ã">
    <link rel="apple-touch-icon" href="icon.svg">
    
    <link rel="manifest" href="manifest.json">
    <title>–°–∞–¥ –ö–∞—Ä–º—ã</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=Lora:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #8D6E63; --accent-color: #D4AF37; --accent-dark: #B8860B;
            --bg-paper: #F5F1E6; --text-ink: #3E2723; --text-light: #5D4037;
            --success-color: #2E7D32; --danger-color: #C62828;
            --shadow-soft: 0 4px 15px rgba(62, 39, 35, 0.15);
        }

        body {
            font-family: 'Lora', serif; margin: 0; background-color: var(--bg-paper);
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
            color: var(--text-ink); min-height: 100vh; padding-bottom: 130px;
        }

        .header {
            background: linear-gradient(to bottom, #5D4037, #3E2723); color: var(--accent-color);
            padding: 15px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid var(--accent-color); box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .header-text h1 { margin: 0; font-family: 'Cormorant Garamond', serif; font-size: 24px; font-weight: 700; letter-spacing: 1px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .header-text p { margin: 2px 0 0; font-size: 11px; opacity: 0.8; font-style: italic; }
        
        .header-btn {
            background: rgba(255,255,255,0.1); border: 1px solid var(--accent-color);
            color: var(--accent-color); padding: 8px 12px; border-radius: 20px;
            font-size: 12px; cursor: pointer; transition: 0.3s; text-decoration: none;
            display: flex; align-items: center; gap: 5px; font-weight: 600;
        }
        .header-btn:hover { background: var(--accent-color); color: #3E2723; }

        .tabs-container {
            display: flex; overflow-x: auto; background: rgba(255,255,255,0.5);
            border-bottom: 1px solid #D7CCC8; position: sticky; top: 0; z-index: 100;
        }
        .tab {
            flex: 1 0 auto; padding: 15px 10px; text-align: center; cursor: pointer;
            border-bottom: 2px solid transparent; transition: 0.3s; font-size: 13px;
            font-weight: 600; color: var(--text-light); white-space: nowrap;
        }
        .tab.active { color: var(--primary-color); border-bottom-color: var(--accent-color); background: rgba(255,255,255,0.8); }

        .container { max-width: 700px; margin: 0 auto; padding: 20px 15px; }
        .empty-state { text-align: center; margin-top: 50px; color: #8D6E63; font-style: italic; }
        .empty-icon { font-size: 50px; opacity: 0.3; margin-bottom: 10px; }

        .card {
            background: rgba(255,255,255,0.9); margin-bottom: 15px; border-radius: 4px;
            border-left: 4px solid var(--accent-color); box-shadow: var(--shadow-soft);
            position: relative; transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-2px); }
        .card-body { padding: 15px; }
        .card-title { font-family: 'Cormorant Garamond', serif; font-size: 18px; font-weight: 700; color: var(--text-ink); margin-bottom: 5px; border-bottom: 1px dashed #D7CCC8; padding-bottom: 5px; }
        .card-text { font-size: 14px; line-height: 1.5; color: var(--text-light); }
        .card-meta { font-size: 12px; margin-top: 10px; color: var(--accent-dark); font-style: italic; display: flex; align-items: center; gap: 5px; }
        .card-actions { display: flex; gap: 10px; margin-top: 12px; border-top: 1px solid #EFEBE9; padding-top: 12px; flex-wrap: wrap; }

        .counters-container { display: flex; gap: 10px; margin-top: 12px; margin-bottom: 5px; }
        .counter-badge {
            display: inline-flex; align-items: center; gap: 5px;
            background: #EFEBE9; padding: 5px 10px; border-radius: 20px;
            font-size: 12px; font-weight: bold; color: var(--text-light);
            cursor: pointer; border: 1px solid transparent; transition: 0.2s;
        }
        .counter-badge:hover { background: #fff; border-color: var(--accent-color); color: var(--text-ink); }
        .counter-badge.done { color: var(--success-color); }
        .counter-badge.zero { opacity: 0.5; pointer-events: none; }

        .btn {
            border: none; padding: 8px 15px; border-radius: 3px; cursor: pointer;
            font-family: 'Lora', serif; font-size: 13px; transition: 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 5px;
            flex: 1;
        }
        .btn-primary { background: transparent; border: 1px solid var(--primary-color); color: var(--primary-color); }
        .btn-success { background: transparent; border: 1px solid var(--success-color); color: var(--success-color); }
        .btn-warning { background: transparent; border: 1px solid #F57F17; color: #F57F17; }
        .btn-danger { background: transparent; border: 1px solid #BDBDBD; color: #757575; }
        
        .btn-delete-confirm { background: var(--danger-color); border-color: var(--danger-color); color: white; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .fab {
            position: fixed; bottom: max(75px, calc(20px + env(safe-area-inset-bottom))); 
            right: 20px; width: 56px; height: 56px;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-dark));
            color: white; border-radius: 50%; border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-size: 24px; cursor: pointer; z-index: 50;
        }
        .meditation-btn {
            position: fixed; bottom: max(75px, calc(20px + env(safe-area-inset-bottom)));
            left: 20px; right: 90px;
            background: linear-gradient(to right, #5D4037, #3E2723); color: var(--accent-color);
            padding: 15px; border-radius: 30px; text-align: center;
            box-shadow: var(--shadow-soft); font-weight: 600; border: 1px solid var(--accent-color);
            z-index: 50; font-size: 14px;
        }

        input, select, textarea {
            width: 100%; padding: 12px; margin: 5px 0 15px; border: 1px solid #D7CCC8;
            border-radius: 3px; background: #FBFBFB; font-family: 'Lora', serif;
            font-size: 16px; color: var(--text-ink); box-sizing: border-box;
        }
        input:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2); }
        label { font-size: 13px; font-weight: 600; color: var(--text-light); }

        /* --- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(62, 39, 35, 0.7); z-index: 200; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal.active { display: flex; }
        .modal-content { background: var(--bg-paper); border-radius: 5px; width: 90%; max-width: 450px; position: relative; border: 1px solid var(--accent-color); box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-height: 85vh; display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { padding: 20px 25px 15px 25px; border-bottom: 1px solid #D7CCC8; position: relative; flex-shrink: 0; background: var(--bg-paper); }
        .modal-header h3 { margin: 0; font-family: 'Cormorant Garamond', serif; color: var(--text-ink); font-size: 20px; padding-right: 30px; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 28px; cursor: pointer; color: var(--primary-color); line-height: 1; background: none; border: none; }
        .modal-body { padding: 20px 25px; overflow-y: auto; flex-grow: 1; }

        .info-text { text-align: left; font-size: 14px; line-height: 1.6; color: var(--text-ink); }
        .info-text h2 { font-family: 'Cormorant Garamond', serif; color: var(--primary-color); border-bottom: 1px solid #D7CCC8; padding-bottom: 10px; margin-top: 25px; font-size: 20px; }
        .info-text h2:first-child { margin-top: 0; }
        .info-text h3 { color: var(--accent-dark); font-size: 17px; margin-top: 15px; margin-bottom: 8px; }
        .info-text p { margin-bottom: 12px; }
        .info-text ul { padding-left: 20px; margin-bottom: 15px; }
        .info-text li { margin-bottom: 8px; }
        .instruction-step { background: rgba(255,255,255,0.6); padding: 15px; border-radius: 5px; margin-bottom: 15px; border-left: 3px solid var(--accent-color); }
        .instruction-step h3 { margin-top: 0; color: var(--accent-dark); font-size: 16px; margin-bottom: 10px; }
        .highlight { color: var(--primary-color); font-weight: bold; }
        .warning-box { background: rgba(198, 40, 40, 0.05); border-left: 3px solid var(--danger-color); padding: 15px; border-radius: 5px; margin: 15px 0; }
        .dev-warning { font-size: 12px; color: var(--danger-color); margin-top: 10px; font-style: italic; }
        
        .info-menu-btn { display: block; width: 100%; padding: 20px; margin-bottom: 10px; background: rgba(255,255,255,0.5); border: 1px solid #D7CCC8; text-align: left; font-family: 'Lora', serif; font-size: 16px; color: var(--text-ink); border-radius: 5px; cursor: pointer; transition: 0.2s; }
        .info-menu-btn:hover { background: #fff; border-color: var(--accent-color); }
        .info-menu-btn span { font-size: 20px; margin-right: 10px; vertical-align: middle; }

        .seed-list-item { background: rgba(255,255,255,0.6); border-left: 3px solid var(--accent-color); padding: 10px; margin-bottom: 8px; font-size: 14px; }
        .seed-list-item.done-item { border-left-color: var(--success-color); background: rgba(46, 125, 50, 0.05); }

        .settings-group { background: rgba(255,255,255,0.5); padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #D7CCC8; }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success-color); }
        input:checked + .slider:before { transform: translateX(22px); }
        
        .btn-action { width: 100%; padding: 15px; font-size: 16px; font-weight: 600; background: linear-gradient(to right, #5D4037, #3E2723); color: var(--accent-color); border: 1px solid var(--accent-color); border-radius: 5px; margin-bottom: 10px; cursor: pointer; font-family: 'Lora', serif; }
        .btn-action:hover { opacity: 0.9; }
        .btn-action.import { background: transparent; color: var(--text-ink); border: 1px solid #D7CCC8; }
        .btn-action.secondary { background: transparent; color: var(--text-light); border: 1px solid #D7CCC8; }
        .btn-action.update { background: linear-gradient(to right, var(--success-color), #1B5E20); border-color: var(--success-color); color: white; }

        .version-box { background: rgba(255,255,255,0.7); border: 1px solid #D7CCC8; border-radius: 8px; padding: 15px; margin-bottom: 15px; text-align: center; }
        .version-number { font-family: 'Cormorant Garamond', serif; font-size: 28px; font-weight: 700; color: var(--primary-color); }
        .version-label { font-size: 12px; color: var(--text-light); margin-bottom: 5px; }
        .version-status { font-size: 14px; margin-top: 10px; padding: 8px; border-radius: 5px; }
        .version-status.checking { background: #FFF3E0; color: #E65100; }
        .version-status.updated { background: #E8F5E9; color: var(--success-color); }
        .version-status.available { background: #FFF8E1; color: #F57F17; }
        .version-status.error { background: #FFEBEE; color: var(--danger-color); }

        /* –ü–ª–∞—à–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è */
        #update-notification { display: none; position: fixed; bottom: 80px; left: 20px; right: 20px; background: var(--accent-color); color: #3E2723; padding: 15px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 1000; text-align: center; font-weight: bold; border: 2px solid #fff; }
    </style>
</head>
<body>

<!-- –ü–ª–∞—à–∫–∞ –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ -->
<div id="update-notification">
    ‚ú® –î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è! 
    <button onclick="updateApp()" style="background: #3E2723; color: var(--accent-color); border: none; padding: 8px 20px; border-radius: 20px; margin-left: 10px; font-weight: bold; cursor: pointer;">–û–±–Ω–æ–≤–∏—Ç—å</button>
</div>

<div class="header">
    <div class="header-text">
        <h1>–°–∞–¥ –ö–∞—Ä–º—ã</h1>
        <p>–ú—É–¥—Ä–æ—Å—Ç—å –¢–∏–±–µ—Ç–∞ –≤ —Ç–≤–æ–µ–º —Å–µ—Ä–¥—Ü–µ</p>
    </div>
    <button class="header-btn" onclick="openInfoMenu()">‚ìò –û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</button>
</div>

<!-- –í–∫–ª–∞–¥–∫–∏ -->
<div class="tabs-container">
    <div class="tab active" onclick="switchTab('goals', this)">üèî –¶–µ–ª–∏</div>
    <div class="tab" onclick="switchTab('planting', this)">üå± –ü–æ—Å–µ–≤</div>
    <div class="tab" onclick="switchTab('done', this)">üôè –°–¥–µ–ª–∞–Ω–æ</div>
    <div class="tab" onclick="switchTab('harvest', this)">üåæ –£—Ä–æ–∂–∞–π</div>
    <div class="tab" onclick="switchTab('settings', this)">‚öôÔ∏è</div>
</div>

<!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
<div class="container">
    <div id="tab-goals" class="tab-content"></div>
    <div id="tab-planting" class="tab-content" style="display:none;"></div>
    <div id="tab-done" class="tab-content" style="display:none;"></div>
    <div id="tab-harvest" class="tab-content" style="display:none;"></div>
    <div id="tab-settings" class="tab-content" style="display:none;"></div>
</div>

<!-- –ö–Ω–æ–ø–∫–∏ -->
<button class="meditation-btn" onclick="openMeditation()">‚òï –ö–æ—Ñ–µ-–º–µ–¥–∏—Ç–∞—Ü–∏—è</button>
<button class="fab" onclick="openModal()">+</button>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->

<!-- 1. –ú–µ–Ω—é "–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏" -->
<div id="info-menu-modal" class="modal">
    <div class="modal-content" style="max-width: 350px;">
        <div class="modal-header">
            <h3>‚ÑπÔ∏è –û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</h3>
            <button class="close-btn" onclick="closeInfoMenu()">&times;</button>
        </div>
        <div class="modal-body" style="text-align: center;">
            <!-- –ë–ª–æ–∫ –≤–µ—Ä—Å–∏–∏ -->
            <div class="version-box">
                <div class="version-label">–í–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</div>
                <div class="version-number" id="app-version">...</div>
                <div class="version-status updated" id="version-status">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <button class="btn-action secondary" onclick="checkForUpdates()" id="check-update-btn">
                üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            </button>
            <button class="btn-action update" onclick="updateApp()" id="update-btn" style="display: none;">
                ‚¨áÔ∏è –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            </button>
            
            <hr style="border: none; border-top: 1px solid #D7CCC8; margin: 20px 0;">
            
            <button class="info-menu-btn" onclick="closeInfoMenu(); openInstruction();"><span>üìñ</span> –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</button>
            <button class="info-menu-btn" onclick="closeInfoMenu(); openPrivacy();"><span>üìú</span> –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</button>
            <button class="info-menu-btn" onclick="closeInfoMenu(); openInstall();"><span>üì≤</span> –ö–∞–∫ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- 2. –û–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div id="modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">–ó–∞–≥–æ–ª–æ–≤–æ–∫</h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="modal-body"></div>
    </div>
</div>

<!-- 3. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
<div id="instruction-modal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header"><h3>üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</h3><button class="close-btn" onclick="closeInstruction()">&times;</button></div>
        <div class="modal-body"><div class="info-text">
            <h2>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è üå±</h2>
            <p>–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–º–æ–∂–µ—Ç —Ç–µ–±–µ –∏–∑–º–µ–Ω–∏—Ç—å —Å–≤–æ—é –∂–∏–∑–Ω—å. <b>–ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ:</b> <span class="highlight">–≤—Å—ë –∏—Å—Ö–æ–¥–∏—Ç –∏–∑ –∫–∞—Ä–º–∏—á–µ—Å–∫–∏—Ö —Å–µ–º—è–Ω –≤ –Ω–∞—à–µ–º —É–º–µ</span>.</p>

            <h2>–®–∞–≥–∏ üß≠</h2>
            <div class="instruction-step"><h3>1. –¶–µ–ª—å üéØ</h3><p>–û–ø—Ä–µ–¥–µ–ª–∏, —á—Ç–æ —Ö–æ—á–µ—à—å –ø–æ–ª—É—á–∏—Ç—å. –†–∞–∑–¥–µ–ª ¬´–¶–µ–ª–∏¬ª.</p></div>
            <div class="instruction-step"><h3>2. –ü–æ—Å–µ–≤ üå±</h3><p>–ü–æ–º–æ–≥–∏ –¥—Ä—É–≥–æ–º—É —á–µ–ª–æ–≤–µ–∫—É —Å –ø–æ—Ö–æ–∂–µ–π –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å—é.</p></div>
            <div class="instruction-step"><h3>3. –°–¥–µ–ª–∞–Ω–æ ‚úÖ</h3><p>–í—ã–ø–æ–ª–Ω–∏ –∏ –Ω–∞–∂–º–∏ ¬´–°–¥–µ–ª–∞–Ω–æ¬ª.</p></div>
            <div class="instruction-step"><h3>4. –ú–µ–¥–∏—Ç–∞—Ü–∏—è ‚òï</h3><p>–†–∞–¥—É–π—Å—è –¥–æ–±—Ä—ã–º –¥–µ–ª–∞–º –∫–∞–∂–¥—ã–π –≤–µ—á–µ—Ä.</p></div>
            
            <div class="instruction-step" style="border-left-color: var(--success-color);">
                <h3>üíæ –ë—ç–∫–∞–ø</h3><p>–≠–∫—Å–ø–æ—Ä—Ç –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Å–æ—Ö—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ.</p>
            </div>
        </div></div>
    </div>
</div>

<!-- 4. –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å -->
<div id="privacy-modal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header"><h3>üîí –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</h3><button class="close-btn" onclick="closePrivacy()">&times;</button></div>
        <div class="modal-body"><div class="info-text">
            <h2>–ü—Ä–∏–≤–µ—Ç! üåø</h2>
            <p>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ –∫–Ω–∏–≥–∞–º –ú–∞–π–∫–ª–∞ –†–æ—É—á–∞.</p>
            <h2>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å üîí</h2>
            <ul><li>–ù–µ —Å–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ.</li><li>–ù–µ—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.</li><li>–î–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –≤ —Ç–≤–æ—ë–º –±—Ä–∞—É–∑–µ—Ä–µ.</li></ul>
            <div class="warning-box"><b>‚ö†Ô∏è –í–∞–∂–Ω–æ:</b> –ü—Ä–∏ —Å–º–µ–Ω–µ –±—Ä–∞—É–∑–µ—Ä–∞ –¥–∞–Ω–Ω—ã–µ –ø–æ—Ç–µ—Ä—è—é—Ç—Å—è. –ò—Å–ø–æ–ª—å–∑—É–π –≠–∫—Å–ø–æ—Ä—Ç!</div>
        </div></div>
    </div>
</div>

<!-- 5. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ -->
<div id="install-modal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header"><h3>üì≤ –£—Å—Ç–∞–Ω–æ–≤–∫–∞</h3><button class="close-btn" onclick="closeInstall()">&times;</button></div>
        <div class="modal-body"><div class="info-text">
            <h2>Android üì±</h2><p>Chrome ‚Üí –ú–µ–Ω—é ‚Üí ¬´–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ¬ª</p>
            <h2>iOS üì±</h2><p>Safari ‚Üí –ü–æ–¥–µ–ª–∏—Ç—å—Å—è ‚Üí ¬´–ù–∞ —ç–∫—Ä–∞–Ω –î–æ–º–æ–π¬ª</p>
            <h2>–ü–ö üíª</h2><p>Chrome ‚Üí –ó–Ω–∞—á–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ</p>
        </div></div>
    </div>
</div>

<!-- 6. –ö–æ—Ñ–µ-–º–µ–¥–∏—Ç–∞—Ü–∏—è -->
<div id="meditation-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3>‚òï –ö–æ—Ñ–µ-–º–µ–¥–∏—Ç–∞—Ü–∏—è</h3><button class="close-btn" onclick="closeMeditation()">&times;</button></div>
        <div class="modal-body"><p style="font-style: italic; color: #5D4037;">–†–∞–¥—É–π—Å—è –¥–æ–±—Ä—ã–º –¥–µ–ª–∞–º...</p><div id="meditation-list"></div></div>
    </div>
</div>

<input type="file" id="import-file-input" accept=".json" style="display:none" onchange="handleFileImport(event)">

<script>
    // === –°–ò–°–¢–ï–ú–ê –í–ï–†–°–ò–ô ===
    let currentVersion = '...';
    let serverVersion = null;
    let swRegistration = null;
    let updateAvailable = false;

    // --- –ë–ê–ó–ê –î–ê–ù–ù–´–• ---
    const DB = {
        getGoals: () => JSON.parse(localStorage.getItem('goals') || '[]'),
        saveGoals: (data) => localStorage.setItem('goals', JSON.stringify(data)),
        getSeeds: () => JSON.parse(localStorage.getItem('seeds') || '[]'),
        saveSeeds: (data) => localStorage.setItem('seeds', JSON.stringify(data)),
        getConfig: () => JSON.parse(localStorage.getItem('config') || '{"time": "22:00", "notify": false}'),
        saveConfig: (data) => localStorage.setItem('config', JSON.stringify(data)),
    };

    let currentTab = 'goals';
    let deleteTimers = {}; 

    function render() { renderGoals(); renderPlanting(); renderDone(); renderHarvest(); renderSettings(); }
    function switchTab(tabName, element) {
        currentTab = tabName;
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.getElementById('tab-' + tabName).style.display = 'block';
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        if(element) element.classList.add('active');
    }
    function escapeHtml(text) { if (!text) return ""; return String(text).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' })[m]); }

    function handleDeleteClick(type, id, btnElement) {
        const key = type + id;
        if (deleteTimers[key]) { clearTimeout(deleteTimers[key]); delete deleteTimers[key]; if (type === 'goal') deleteGoalNow(id); else deleteSeedNow(id); } 
        else { btnElement.classList.add('btn-delete-confirm'); btnElement.innerText = "–¢–æ—á–Ω–æ?"; deleteTimers[key] = setTimeout(() => { btnElement.classList.remove('btn-delete-confirm'); btnElement.innerText = "–£–¥–∞–ª–∏—Ç—å"; delete deleteTimers[key]; }, 3000); }
    }
    function deleteGoalNow(id) { DB.saveGoals(DB.getGoals().filter(g => g.id !== id)); render(); }
    function deleteSeedNow(id) { DB.saveSeeds(DB.getSeeds().filter(s => s.id !== id)); render(); }

    function renderGoals() {
        const container = document.getElementById('tab-goals'); const goals = DB.getGoals().filter(g => !g.completed); const allSeeds = DB.getSeeds();
        if (goals.length === 0) { container.innerHTML = '<div class="empty-state"><div class="empty-icon">üèî</div>–¢–≤–æ–∏ –≤–µ—Ä—à–∏–Ω—ã –∂–¥—É—Ç –ø–æ–∫–æ—Ä–µ–Ω–∏—è</div>'; return; }
        container.innerHTML = goals.map(g => {
            const relatedSeeds = allSeeds.filter(s => s.goalId === g.id); const plannedCount = relatedSeeds.filter(s => !s.isActionDone).length; const doneCount = relatedSeeds.filter(s => s.isActionDone && !s.isGoalAchieved).length;
            return `<div class="card"><div class="card-body"><div class="card-title">–¶–µ–ª—å: ${escapeHtml(g.desire)}</div><div class="card-text">–ò—Å–ø—Ä–∞–≤–∏—Ç—å: ${escapeHtml(g.problem)}</div>
            <div class="counters-container"><div class="counter-badge ${plannedCount === 0 ? 'zero' : ''}" onclick="showSeedsList(${g.id}, 'planned')">üå± –ü–æ—Å–µ–≤: ${plannedCount}</div><div class="counter-badge done ${doneCount === 0 ? 'zero' : ''}" onclick="showSeedsList(${g.id}, 'done')">üôè –°–¥–µ–ª–∞–Ω–æ: ${doneCount}</div></div>
            <div class="card-actions"><button class="btn btn-warning" onclick="openEditGoalModal(${g.id})">‚úé</button><button class="btn btn-success" onclick="achieveGoal(${g.id})">‚úì</button><button class="btn btn-danger" onclick="handleDeleteClick('goal', ${g.id}, this)">–£–¥–∞–ª–∏—Ç—å</button></div></div></div>`;
        }).join('');
    }
    
    function renderPlanting() {
        const container = document.getElementById('tab-planting'); const seeds = DB.getSeeds().filter(s => !s.isActionDone);
        if (seeds.length === 0) { container.innerHTML = '<div class="empty-state"><div class="empty-icon">üå±</div>–í—Ä–µ–º—è –ø–æ—Å–∞–¥–∫–∏</div>'; return; }
        container.innerHTML = seeds.map(s => `<div class="card"><div class="card-body"><div class="card-meta">üéØ ${escapeHtml(s.goalText)}</div><div class="card-title">–î–ª—è: ${escapeHtml(s.person)}</div><div class="card-text">${escapeHtml(s.action)}</div>
        <div class="card-actions"><button class="btn btn-warning" onclick="openEditSeedModal(${s.id})">‚úé</button><button class="btn btn-success" onclick="completeSeedAction(${s.id})">‚úì –°–¥–µ–ª–∞–Ω–æ</button><button class="btn btn-danger" onclick="handleDeleteClick('seed', ${s.id}, this)">–£–¥–∞–ª–∏—Ç—å</button></div></div></div>`).join('');
    }
    function renderDone() {
        const container = document.getElementById('tab-done'); const seeds = DB.getSeeds().filter(s => s.isActionDone && !s.isGoalAchieved);
        if (seeds.length === 0) { container.innerHTML = '<div class="empty-state"><div class="empty-icon">üôè</div>–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>'; return; }
        container.innerHTML = seeds.map(s => `<div class="card"><div class="card-body"><div class="card-meta">üéØ ${escapeHtml(s.goalText)}</div><div class="card-title">–î–ª—è: ${escapeHtml(s.person)}</div><div class="card-text">${escapeHtml(s.action)}</div>
        <div class="card-actions"><button class="btn btn-primary" onclick="undoSeedAction(${s.id})">‚Ü© –í–µ—Ä–Ω—É—Ç—å</button><button class="btn btn-danger" onclick="handleDeleteClick('seed', ${s.id}, this)">–£–¥–∞–ª–∏—Ç—å</button></div></div></div>`).join('');
    }
    function renderHarvest() {
        const container = document.getElementById('tab-harvest'); const seeds = DB.getSeeds().filter(s => s.isGoalAchieved);
        if (seeds.length === 0) { container.innerHTML = '<div class="empty-state"><div class="empty-icon">üåæ</div>–£—Ä–æ–∂–∞–π —Å–æ–∑—Ä–µ–µ—Ç —Å–∫–æ—Ä–æ</div>'; return; }
        container.innerHTML = seeds.map(s => `<div class="card" style="border-left-color: var(--success-color);"><div class="card-body"><div class="card-title" style="color: var(--success-color);">–£—Ä–æ–∂–∞–π: ${escapeHtml(s.goalText)}</div><div class="card-text">–î–ª—è <b>${escapeHtml(s.person)}</b>: ${escapeHtml(s.action)}</div>
        <div class="card-actions"><button class="btn btn-danger" onclick="handleDeleteClick('seed', ${s.id}, this)">–£–¥–∞–ª–∏—Ç—å</button></div></div></div>`).join('');
    }
    function showSeedsList(goalId, type) {
        const seeds = DB.getSeeds().filter(s => s.goalId === goalId); let list = []; let title = "";
        if (type === 'planned') { list = seeds.filter(s => !s.isActionDone); title = "üå± –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ"; } else { list = seeds.filter(s => s.isActionDone && !s.isGoalAchieved); title = "üôè –°–¥–µ–ª–∞–Ω–Ω—ã–µ"; }
        const body = document.getElementById('modal-body'); const header = document.getElementById('modal-title'); header.innerText = title;
        if (list.length === 0) { body.innerHTML = '<p style="text-align:center; color:#8D6E63">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</p>'; } else { body.innerHTML = list.map(s => `<div class="seed-list-item ${type === 'done' ? 'done-item' : ''}"><div><b>–î–ª—è –∫–æ–≥–æ:</b> ${escapeHtml(s.person)}</div><div><b>–î–µ–π—Å—Ç–≤–∏–µ:</b> ${escapeHtml(s.action)}</div></div>`).join(''); }
        document.getElementById('modal').classList.add('active');
    }
    
    function renderSettings() {
        const container = document.getElementById('tab-settings'); const config = DB.getConfig();
        container.innerHTML = `
            <h3 style="font-family: 'Cormorant Garamond', serif; border-bottom: 2px solid var(--accent-color); padding-bottom: 10px;">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <div class="settings-group">
                <div style="display: flex; justify-content: space-between; align-items: center;"><label style="margin: 0;">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</label><label class="toggle-switch"><input type="checkbox" id="notify-toggle" ${config.notify ? 'checked' : ''} onchange="toggleNotification(this.checked)"><span class="slider"></span></label></div>
                <div><label>–í—Ä–µ–º—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</label><input type="time" id="reminder-time" value="${config.time}" onchange="updateTime(this.value)" style="margin-bottom: 0;"></div>
                <p class="dev-warning">‚ö†Ô∏è –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.</p>
            </div>
            <h3 style="font-family: 'Cormorant Garamond', serif; border-bottom: 2px solid var(--accent-color); padding-bottom: 10px; margin-top: 30px;">üíæ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è</h3>
            <div class="settings-group" style="text-align: center;">
                <button class="btn-action" onclick="exportData()">üì§ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
                <button class="btn-action import" onclick="document.getElementById('import-file-input').click()">üì• –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
            </div>
            <button class="btn-action secondary" style="margin-top: 30px;" onclick="openInfoMenu()">üìú –û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</button>`;
    }

    function openInfoMenu() { 
        document.getElementById('info-menu-modal').classList.add('active');
        updateVersionDisplay();
    }
    function closeInfoMenu() { document.getElementById('info-menu-modal').classList.remove('active'); }
    function openInstruction() { document.getElementById('instruction-modal').classList.add('active'); }
    function closeInstruction() { document.getElementById('instruction-modal').classList.remove('active'); }
    function openPrivacy() { document.getElementById('privacy-modal').classList.add('active'); }
    function closePrivacy() { document.getElementById('privacy-modal').classList.remove('active'); }
    function openInstall() { document.getElementById('install-modal').classList.add('active'); }
    function closeInstall() { document.getElementById('install-modal').classList.remove('active'); }
    function closeModal() { document.getElementById('modal').classList.remove('active'); }

    // === –§–£–ù–ö–¶–ò–ò –í–ï–†–°–ò–ô ===
    async function getVersionFromSW() {
        return new Promise((resolve) => {
            if (!navigator.serviceWorker.controller) {
                resolve(null);
                return;
            }
            
            const messageChannel = new MessageChannel();
            messageChannel.port1.onmessage = (event) => {
                resolve(event.data.version);
            };
            
            navigator.serviceWorker.controller.postMessage('GET_VERSION', [messageChannel.port2]);
            
            // –¢–∞–π–º–∞—É—Ç
            setTimeout(() => resolve(null), 1000);
        });
    }

    async function getServerVersion() {
        try {
            const response = await fetch('/sad-karmy/version.json?t=' + Date.now());
            if (response.ok) {
                const data = await response.json();
                return data.version;
            }
        } catch (e) {
            console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–µ—Ä—Å–∏—é —Å —Å–µ—Ä–≤–µ—Ä–∞');
        }
        return null;
    }

    async function updateVersionDisplay() {
        const versionEl = document.getElementById('app-version');
        const statusEl = document.getElementById('version-status');
        const updateBtn = document.getElementById('update-btn');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é –æ—Ç SW
        versionEl.textContent = currentVersion;
        
        if (updateAvailable) {
            statusEl.className = 'version-status available';
            statusEl.textContent = '‚¨ÜÔ∏è –î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ';
            updateBtn.style.display = 'block';
        } else {
            statusEl.className = 'version-status updated';
            statusEl.textContent = '‚úì –ê–∫—Ç—É–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è';
            updateBtn.style.display = 'none';
        }
    }

    async function checkForUpdates() {
        const statusEl = document.getElementById('version-status');
        const checkBtn = document.getElementById('check-update-btn');
        
        statusEl.className = 'version-status checking';
        statusEl.textContent = 'üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π...';
        checkBtn.disabled = true;
        
        try {
            // –ü–æ–ª—É—á–∞–µ–º –≤–µ—Ä—Å–∏—é —Å —Å–µ—Ä–≤–µ—Ä–∞
            serverVersion = await getServerVersion();
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º SW
            if (swRegistration) {
                await swRegistration.update();
            }
            
            // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –≤–µ—Ä—Å–∏–∏
            if (serverVersion && serverVersion !== currentVersion) {
                updateAvailable = true;
            } else {
                updateAvailable = false;
            }
            
            updateVersionDisplay();
        } catch (error) {
            statusEl.className = 'version-status error';
            statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏';
        }
        
        checkBtn.disabled = false;
    }

    function updateApp() {
        if (swRegistration && swRegistration.waiting) {
            swRegistration.waiting.postMessage('skipWaiting');
        }
        document.getElementById('update-notification').style.display = 'none';
        updateAvailable = false;
    }

    function exportData() { const data = { goals: DB.getGoals(), seeds: DB.getSeeds(), config: DB.getConfig(), exportDate: new Date().toISOString() }; const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'saddharma_backup_' + new Date().toLocaleDateString('ru-RU').replace(/\./g, '-') + '.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
    function handleFileImport(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const data = JSON.parse(e.target.result); if (data.goals && data.seeds) { if(confirm('–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ?')) { DB.saveGoals(data.goals); DB.saveSeeds(data.seeds); if(data.config) DB.saveConfig(data.config); alert('–ì–æ—Ç–æ–≤–æ!'); render(); } } else alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç'); } catch (err) { alert('–û—à–∏–±–∫–∞'); } }; reader.readAsText(file); event.target.value = ''; }
    function toggleNotification(enabled) { let config = DB.getConfig(); config.notify = enabled; DB.saveConfig(config); alert('–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.'); }
    function updateTime(time) { let config = DB.getConfig(); config.time = time; DB.saveConfig(config); }
    
    function openModal() { if(currentTab === 'harvest' || currentTab === 'done' || currentTab === 'settings') return; const body = document.getElementById('modal-body'); const title = document.getElementById('modal-title'); if (currentTab === 'goals') { title.innerText = "–ù–æ–≤–∞—è —Ü–µ–ª—å"; body.innerHTML = `<label>–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å?</label><input type="text" id="input-fix"><label>–ß—Ç–æ –ø–æ–ª—É—á–∏—Ç—å?</label><input type="text" id="input-want"><button class="btn btn-success" style="width:100%" onclick="saveGoal()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`; } else if (currentTab === 'planting') { const activeGoals = DB.getGoals().filter(g => !g.completed); if (activeGoals.length === 0) { alert('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ü–µ–ª–µ–π!'); return; } const options = activeGoals.map(g => `<option value="${g.id}">${escapeHtml(g.desire)}</option>`).join(''); title.innerText = "–ü–æ—Å–µ—è—Ç—å —Å–µ–º—è"; body.innerHTML = `<label>–¶–µ–ª—å</label><select id="input-goal-id">${options}</select><label>–ò–º—è —á–µ–ª–æ–≤–µ–∫–∞</label><input type="text" id="input-person"><label>–î–µ–π—Å—Ç–≤–∏–µ</label><input type="text" id="input-action"><button class="btn btn-success" style="width:100%" onclick="saveSeed()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`; } document.getElementById('modal').classList.add('active'); }

    function saveGoal() { const fix = document.getElementById('input-fix').value; const want = document.getElementById('input-want').value; if (!fix || !want) return alert('–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è'); const goals = DB.getGoals(); goals.push({ id: Date.now(), problem: fix, desire: want, completed: false }); DB.saveGoals(goals); closeModal(); render(); }
    function openEditGoalModal(id) { const goal = DB.getGoals().find(g => g.id === id); if(!goal) return; document.getElementById('modal-title').innerText = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–ª—å"; document.getElementById('modal-body').innerHTML = `<label>–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å?</label><input type="text" id="input-fix" value="${escapeHtml(goal.problem)}"><label>–ß—Ç–æ –ø–æ–ª—É—á–∏—Ç—å?</label><input type="text" id="input-want" value="${escapeHtml(goal.desire)}"><button class="btn btn-success" style="width:100%" onclick="saveEditedGoal(${id})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`; document.getElementById('modal').classList.add('active'); }
    function saveEditedGoal(id) { let goals = DB.getGoals(); const newFix = document.getElementById('input-fix').value; const newWant = document.getElementById('input-want').value; if(!newFix || !newWant) return alert('–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è'); goals = goals.map(g => g.id === id ? {...g, problem: newFix, desire: newWant} : g); let seeds = DB.getSeeds().map(s => s.goalId === id ? {...s, goalText: newWant} : s); DB.saveGoals(goals); DB.saveSeeds(seeds); closeModal(); render(); }
    function achieveGoal(id) { if(!confirm('–î–æ—Å—Ç–∏–≥–Ω—É—Ç–∞ —Ü–µ–ª—å?')) return; let goals = DB.getGoals().map(g => g.id === id ? {...g, completed: true} : g); let seeds = DB.getSeeds().map(s => s.goalId === id ? {...s, isGoalAchieved: true} : s); DB.saveGoals(goals); DB.saveSeeds(seeds); render(); }
    
    function saveSeed() { const goalId = parseInt(document.getElementById('input-goal-id').value); const goalObj = DB.getGoals().find(g => g.id === goalId); const person = document.getElementById('input-person').value; const action = document.getElementById('input-action').value; if (!person || !action) return alert('–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è'); const seeds = DB.getSeeds(); seeds.push({ id: Date.now(), goalId: goalId, goalText: goalObj.desire, person: person, action: action, isActionDone: false, isGoalAchieved: false }); DB.saveSeeds(seeds); closeModal(); render(); }
    function openEditSeedModal(id) { const seed = DB.getSeeds().find(s => s.id === id); if(!seed) return; const activeGoals = DB.getGoals().filter(g => !g.completed); const options = activeGoals.map(g => `<option value="${g.id}" ${g.id === seed.goalId ? 'selected' : ''}>${escapeHtml(g.desire)}</option>`).join(''); document.getElementById('modal-title').innerText = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–µ–º—è"; document.getElementById('modal-body').innerHTML = `<label>–¶–µ–ª—å</label><select id="input-goal-id">${options}</select><label>–ò–º—è</label><input type="text" id="input-person" value="${escapeHtml(seed.person)}"><label>–î–µ–π—Å—Ç–≤–∏–µ</label><input type="text" id="input-action" value="${escapeHtml(seed.action)}"><button class="btn btn-success" style="width:100%" onclick="saveEditedSeed(${id})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`; document.getElementById('modal').classList.add('active'); }
    function saveEditedSeed(id) { const newGoalId = parseInt(document.getElementById('input-goal-id').value); const newGoalObj = DB.getGoals().find(g => g.id === newGoalId); const newPerson = document.getElementById('input-person').value; const newAction = document.getElementById('input-action').value; if(!newPerson || !newAction) return alert('–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è'); let seeds = DB.getSeeds().map(s => s.id === id ? {...s, goalId: newGoalId, goalText: newGoalObj.desire, person: newPerson, action: newAction} : s); DB.saveSeeds(seeds); closeModal(); render(); }

    function completeSeedAction(id) { let seeds = DB.getSeeds().map(s => s.id === id ? {...s, isActionDone: true} : s); DB.saveSeeds(seeds); render(); }
    function undoSeedAction(id) { let seeds = DB.getSeeds().map(s => s.id === id ? {...s, isActionDone: false} : s); DB.saveSeeds(seeds); render(); }

    function openMeditation() { const seeds = DB.getSeeds().filter(s => s.isActionDone && !s.isGoalAchieved); const mList = document.getElementById('meditation-list'); if (seeds.length === 0) { mList.innerHTML = '<p style="text-align:center; color:#8D6E63">–ù–µ—Ç –¥–æ–±—Ä—ã—Ö –¥–µ–ª.</p>'; } else { mList.innerHTML = seeds.map(s => `<div style="background: #fff; border-left: 3px solid var(--success-color); padding: 10px; margin-bottom: 10px; font-size: 14px;">–Ø —Å–¥–µ–ª–∞–ª –¥–ª—è <b>${escapeHtml(s.person)}</b>: ${escapeHtml(s.action)}.<br><span style="font-size: 12px; color: var(--text-light);">–ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å: ${escapeHtml(s.goalText)}</span></div>`).join(''); } document.getElementById('meditation-modal').classList.add('active'); }
    function closeMeditation() { document.getElementById('meditation-modal').classList.remove('active'); }

    // === SERVICE WORKER ===
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', async function() {
            try {
                swRegistration = await navigator.serviceWorker.register('/sad-karmy/service-worker.js');
                console.log('‚úÖ SW –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', swRegistration.scope);
                
                // –ü–æ–ª—É—á–∞–µ–º –≤–µ—Ä—Å–∏—é –æ—Ç SW
                currentVersion = await getVersionFromSW() || '?.?.?';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∂–∏–¥–∞—é—â–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                if (swRegistration.waiting) {
                    updateAvailable = true;
                    document.getElementById('update-notification').style.display = 'block';
                }
                
                // –°–ª—É—à–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                swRegistration.addEventListener('updatefound', function() {
                    const newWorker = swRegistration.installing;
                    newWorker.addEventListener('statechange', async function() {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            updateAvailable = true;
                            document.getElementById('update-notification').style.display = 'block';
                            // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
                            currentVersion = await getVersionFromSW() || currentVersion;
                        }
                    });
                });
            } catch (error) {
                console.log('‚ùå –û—à–∏–±–∫–∞ SW:', error);
                currentVersion = '?.?.?';
            }
        });
        
        // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç SW
        navigator.serviceWorker.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'VERSION') {
                currentVersion = event.data.version;
                updateVersionDisplay();
            }
        });
        
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
        navigator.serviceWorker.addEventListener('controllerchange', function() {
            window.location.reload();
        });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    render();
</script>

</body>
</html>
